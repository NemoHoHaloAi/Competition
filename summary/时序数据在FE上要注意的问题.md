# Time-Series数据在FE上处理时要注意的问题

1. 时刻注意预测数据与训练数据在特征构建上的一致性：
    1. 例如构建dayofyear_store_avg_visitors类的特征；
    2. 首先考虑测试数据对应的dayofyear范围是否被平均包含在训练数据中，假设训练数据从2020年1月到10月，测试数据从2020年11月到12月，那这个特征基本是无意义的，因为11到12月的dayofyear根本不在训练数据中出现，因此对应特征构建结果均为0；
    3. 考虑多个维度下是否都有有意义的值，假设训练数据是2019整年，测试数据是2020年1月到3月，看着时间上是正常的，但是注意如果要根据store维度再细化就要看细化后是否对应特征还是有意义的值而不是0了；
    4. lag、avg类型的特征从时间维度上分为两类：相对值、绝对值，day_block_num就是绝对值，dayofweek就是相对值，相对值也是有相对离散度的，比如dayofyear就比dayofweek更离散一些，越是离散的特征越要考虑是否会导致训练数据与测试数据的特征值分布不一致；
    5. 确保验证集和测试集的各项特征值分布一致性，如果出现某个特征在验证集上有意义，在测试集上都是0，那么最终可能因为这个特征导致过拟合；
2. 一致性检验：
    1. 可以通过对比train和test中对应这些特征；
    2. 对比方式可以选择describe；
3. 问题特征的检验恢复：
    1. 恢复的发起点应该是EDA；
    2. 在EDA中对这些特征依赖的原因数据进行可视化，比如分布情况、时间关系、趋势等等；
    3. 恢复过程中应该时刻谨慎对结果进行describe检验；
4. 时序问题特征与valid划分之间的矛盾：
    - 部分avg特征，例如:month_avg_visitors，该特征是统计每个月的平均顾客数，如果加入store维度，那就是每个月每家店的平均顾客数；
    - valid划分：假设test为2020年11月和12月，那么通常valid划分为2020年9月和10月，这样保证了时间长度是一致的两个月，且维持了时序的前后关系；
    - 矛盾：valid是9月10月，test是11月12月，如果这四个月数据差异明显，整个train时间周期并不长，导致该特征在valid和test上表现迥异，因此valid在该特征上就失去了验证的意义，结果通常是错误的，表现为test得分明显低于valid；
    - 解决：
        - 数据量：数据量足够的话，比如有10年数据，那么会一定程度改善该问题；
        - valid划分方式：比如使用19年的11月12月做验证集，当然这样对数据量的要求也是比较高；
        - 去除有影响的这部分特征，减少特征构建使用的维度，维度越小，每个组下数据越多，avg更可靠；
5. 时序特征构建中使用了test中填充为0的目标特征导致构建的特征在数值上偏小的问题：
    - 比如构建year_avg_visitors，而训练数据为2019年全年，测试数据为2020年1月2月，那么此时2020年对应的avg_visitors就是0，但是valid上是2019的值，不为0，因此该特征对测试机没有意义；
6. 时序数据FE过程中是使用了target的，这对valid的影响要关注：
    - 同样test的target通常被full为0，后续特征构建中的主力其实就是对target进行多维度的挖掘；
    - 问题1. 构建过程相当于使用了valid的target，最终用这些target来预测valid，这明显是数据泄露，通常导致最终得分明显低于valid得分；
    - 问题2. 由于test中都是0，这在构建中会导致使用这部分0构建的特征值的均值之类的统计数据有偏差，通常是偏低，但是valid不会，这里也是因为数据泄露；
